<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>gp-tab-video Preview</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { background: #141414; color: #fff; font-family: -apple-system, BlinkMacSystemFont, sans-serif; }

    .toolbar {
      display: flex; align-items: center; gap: 12px;
      padding: 12px 20px; background: #1a1a1a; border-bottom: 1px solid #333;
      flex-wrap: wrap;
    }
    .toolbar label { font-size: 13px; color: #aaa; }
    .toolbar select, .toolbar input[type="file"] {
      background: #222; color: #fff; border: 1px solid #444; border-radius: 4px;
      padding: 4px 8px; font-size: 13px;
    }
    .toolbar select[multiple] {
      min-height: 28px; max-height: 80px;
    }
    .toolbar button {
      background: #c33; color: #fff; border: none; border-radius: 4px;
      padding: 6px 14px; cursor: pointer; font-size: 13px; font-weight: 600;
    }
    .toolbar button:hover { background: #e44; }
    .toolbar button:disabled { background: #444; cursor: not-allowed; }
    .toolbar .spacer { flex: 1; }

    .track-chips {
      display: flex; gap: 6px; flex-wrap: wrap;
    }
    .track-chip {
      display: inline-flex; align-items: center; gap: 4px;
      padding: 4px 10px; border-radius: 4px; font-size: 12px;
      cursor: pointer; border: 2px solid transparent;
      transition: all 0.15s;
    }
    .track-chip.active { border-color: currentColor; }
    .track-chip:not(.active) { opacity: 0.4; }
    .track-chip .dot {
      width: 8px; height: 8px; border-radius: 50%;
    }

    .info { padding: 8px 20px; font-size: 12px; color: #888; background: #111; }
    .info span { margin-right: 16px; }

    #alphaTab {
      width: 100%; overflow: auto;
      position: relative;
    }

    /* alphaTab default dark theme overrides */
    .at-surface { background: #141414 !important; }
    .at-cursor-bar { background: rgba(255, 50, 50, 0.08) !important; }
    .at-cursor-beat {
      background: rgba(255, 50, 50, 0.9) !important;
      width: 3px !important;
    }
    .at-selection { background: rgba(255, 50, 50, 0.1) !important; }

    .drop-zone {
      display: flex; align-items: center; justify-content: center;
      height: 300px; margin: 40px; border: 2px dashed #444; border-radius: 12px;
      font-size: 18px; color: #666;
    }
    .drop-zone.dragover { border-color: #c33; color: #c33; }
    .hidden { display: none; }
  </style>
</head>
<body>

<div class="toolbar">
  <input type="file" id="fileInput" accept=".gp,.gp3,.gp4,.gp5,.gp6,.gp7,.gpx">
  <label>Tracks:</label>
  <div class="track-chips" id="trackChips"></div>
  <label>Layout:</label>
  <select id="layoutSelect">
    <option value="horizontal">Horizontal (video preview)</option>
    <option value="page">Page (reading)</option>
  </select>
  <div class="spacer"></div>
  <button id="playBtn" disabled>Play</button>
  <button id="stopBtn" disabled>Stop</button>
</div>

<div class="info" id="infoBar">
  <span>Load a Guitar Pro file to preview</span>
</div>

<div id="dropZone" class="drop-zone">
  Drop a Guitar Pro file here, or use the file picker above
</div>

<div id="alphaTab" class="hidden"></div>

<script type="module">
  const script = document.createElement('script');
  script.src = '/node_modules/@coderline/alphatab/dist/alphaTab.js';
  script.onload = () => initApp();
  document.head.appendChild(script);

  // ERRA-inspired track color palettes
  const TRACK_COLORS = [
    { name: 'white',  rgb: [255, 255, 255], css: '#ffffff' },
    { name: 'pink',   rgb: [255, 120, 180], css: '#ff78b4' },
    { name: 'cyan',   rgb: [100, 220, 255], css: '#64dcff' },
    { name: 'gold',   rgb: [255, 200, 80],  css: '#ffc850' },
    { name: 'green',  rgb: [120, 255, 160], css: '#78ffa0' },
  ];

  let api = null;
  let activeTracks = new Set();

  function initApp() {
    const fileInput = document.getElementById('fileInput');
    const trackChips = document.getElementById('trackChips');
    const layoutSelect = document.getElementById('layoutSelect');
    const playBtn = document.getElementById('playBtn');
    const stopBtn = document.getElementById('stopBtn');
    const infoBar = document.getElementById('infoBar');
    const dropZone = document.getElementById('dropZone');
    const container = document.getElementById('alphaTab');

    // Drag and drop
    dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('dragover');
      if (e.dataTransfer.files.length > 0) loadFile(e.dataTransfer.files[0]);
    });

    fileInput.addEventListener('change', () => {
      if (fileInput.files.length > 0) loadFile(fileInput.files[0]);
    });

    // Check for server-provided file
    let preselectedTracks = null;
    fetch('/api/file-info').then(r => r.json()).then(info => {
      if (info.tracks) preselectedTracks = info.tracks;
      if (info.file) {
        infoBar.innerHTML = `<span>Loading ${info.file}...</span>`;
        loadFromUrl('/api/file');
      }
    }).catch(() => {});

    async function loadFile(file) {
      const buffer = await file.arrayBuffer();
      initAlphaTab(new Uint8Array(buffer), file.name);
    }

    async function loadFromUrl(url) {
      const resp = await fetch(url);
      const buffer = await resp.arrayBuffer();
      const filename = url.split('/').pop() || 'score';
      initAlphaTab(new Uint8Array(buffer), filename);
    }

    function renderSelectedTracks() {
      if (!api || !api.score) return;
      const tracks = [...activeTracks].sort().map(i => api.score.tracks[i]);
      if (tracks.length === 0) return;

      // Apply per-track colors
      let colorIdx = 0;
      for (const idx of [...activeTracks].sort()) {
        const track = api.score.tracks[idx];
        const c = TRACK_COLORS[colorIdx % TRACK_COLORS.length];
        track.color = new alphaTab.model.Color(c.rgb[0], c.rgb[1], c.rgb[2], 255);
        colorIdx++;
      }

      api.renderTracks(tracks);
    }

    function buildTrackChips(score) {
      trackChips.innerHTML = '';
      activeTracks.clear();

      // Use preselected tracks if provided, otherwise default to track 0
      const initialTracks = preselectedTracks || [0];
      for (const idx of initialTracks) {
        if (idx < score.tracks.length) activeTracks.add(idx);
      }
      if (activeTracks.size === 0) activeTracks.add(0);

      score.tracks.forEach((t, i) => {
        const chip = document.createElement('div');
        chip.className = 'track-chip' + (activeTracks.has(i) ? ' active' : '');
        const c = TRACK_COLORS[i % TRACK_COLORS.length];
        chip.style.color = c.css;
        chip.style.background = c.css + '18'; // 10% opacity fill

        const dot = document.createElement('span');
        dot.className = 'dot';
        dot.style.background = c.css;
        chip.appendChild(dot);

        const label = document.createTextNode(`[${i}] ${t.name}`);
        chip.appendChild(label);

        chip.addEventListener('click', () => {
          if (activeTracks.has(i)) {
            if (activeTracks.size > 1) {
              activeTracks.delete(i);
              chip.classList.remove('active');
            }
          } else {
            activeTracks.add(i);
            chip.classList.add('active');
          }
          renderSelectedTracks();
        });

        trackChips.appendChild(chip);
      });
    }

    function initAlphaTab(data, filename) {
      dropZone.classList.add('hidden');
      container.classList.remove('hidden');

      if (api) {
        api.destroy();
        container.innerHTML = '';
      }

      const settings = new alphaTab.Settings();
      settings.core.fontDirectory = '/node_modules/@coderline/alphatab/dist/font/';
      settings.player.enablePlayer = true;
      settings.player.enableCursor = true;
      settings.player.enableUserInteraction = true;
      settings.player.scrollMode = alphaTab.ScrollMode.Continuous;
      settings.player.scrollSpeed = 300;
      settings.player.scrollElement = container;
      settings.player.soundFont = '/node_modules/@coderline/alphatab/dist/soundfont/sonivox.sf2';
      settings.display.layoutMode = alphaTab.LayoutMode.Horizontal;

      // Dark theme colors
      const res = settings.display.resources;
      res.mainGlyphColor = new alphaTab.model.Color(255, 255, 255, 255);
      res.staffLineColor = new alphaTab.model.Color(180, 180, 180, 255);
      res.barSeparatorColor = new alphaTab.model.Color(100, 100, 100, 255);
      res.barNumberColor = new alphaTab.model.Color(180, 180, 180, 255);
      res.secondaryGlyphColor = new alphaTab.model.Color(180, 180, 180, 200);
      res.scoreInfoColor = new alphaTab.model.Color(255, 255, 255, 255);

      api = new alphaTab.AlphaTabApi(container, settings);

      api.scoreLoaded.on((score) => {
        buildTrackChips(score);

        // Tab-only
        for (const track of score.tracks) {
          for (const staff of track.staves) {
            staff.showTablature = true;
            staff.showStandardNotation = false;
          }
        }

        // Update info bar
        const tempo = score.tempo;
        const bars = score.masterBars.length;
        infoBar.innerHTML = `
          <span>${filename}</span>
          <span>${score.title || '(untitled)'}</span>
          <span>${tempo} BPM</span>
          <span>${bars} bars</span>
          <span>${score.tracks.length} tracks</span>
        `;

        playBtn.disabled = false;
        stopBtn.disabled = false;

        // If multiple tracks pre-selected, render them now
        if (activeTracks.size > 1) {
          setTimeout(() => renderSelectedTracks(), 100);
        }
      });

      api.load(data);

      layoutSelect.addEventListener('change', () => {
        api.settings.display.layoutMode = layoutSelect.value === 'horizontal'
          ? alphaTab.LayoutMode.Horizontal
          : alphaTab.LayoutMode.Page;
        api.updateSettings();
        api.render();
      });

      playBtn.addEventListener('click', () => {
        if (api.playerState === alphaTab.synth.PlayerState.Playing) {
          api.pause();
          playBtn.textContent = 'Play';
        } else {
          api.play();
          playBtn.textContent = 'Pause';
        }
      });

      stopBtn.addEventListener('click', () => {
        api.stop();
        playBtn.textContent = 'Play';
      });
    }

    // Resize handled by CSS (auto height)
  }
</script>
</body>
</html>
